!function(){"use strict";function Class(){this.__listeners={}}function DataRange(t){Class.call(this),this.initOptions({min:0,max:0}),this.set("layer",t),this.bindTo("data",t),this.bindTo("drawOptions",t),this.bindTo("drawType",t)}function Animation(t){var e={duration:1e3,fps:30,delay:0,transition:Transitions.linear,onStop:function(){}};if(this._anis=[],t)for(var a in t)e[a]=t[a];if(this._opts=e,isNumber(e.delay)){var i=this;setTimeout(function(){i.start()},e.delay)}else e.delay!=Animation.INFINITE&&this.start()}function getCurrentTime(){return(new Date).getTime()}function isNumber(t){return"number"==typeof t}function SizeDataRange(){DataRange.call(this)}function TimeLine(t){Class.call(this)}function Mapv(t){Class.call(this),this.initOptions($.extend({map:null,drawTypeControl:!1,drawTypeControlOptions:{a:1}},t)),this._layers=[],this.notify("drawTypeControl"),this.mapEvent=new MapEvent(t.map)}function MapEvent(t){t.addEventListener("mousemove",function(t){for(var e in MapEvent_events.mousemove)MapEvent_events.mousemove[e](t)}),t.addEventListener("click",function(t){for(var e in MapEvent_events.click)MapEvent_events.click[e](t)})}function CanvasLayer(t){this.options=t||{},this.paneName=this.options.paneName||"labelPane",this.zIndex=this.options.zIndex||0,this.context=this.options.context||"2d",this._map=t.map,this.show()}function Layer(t){Class.call(this),this._drawer={},this.initOptions($.extend({ctx:null,animationCtx:null,mapv:null,paneName:"labelPane",map:null,context:"2d",data:[],dataType:"point",animationOptions:{size:5},coordType:"bd09ll",drawType:"simple",animation:!1,geometry:null,dataRangeControl:!0,zIndex:1},t)),this.dataRangeControl=new DataRangeControl,this.Scale=new DrawScale,this.notify("data"),this.notify("mapv")}function DataControl(t){this.initDom(),this.initEvent(),this["super"]=t,this.geoData=t.geoData}function DataRangeControl(){this.defaultAnchor=BMAP_ANCHOR_BOTTOM_RIGHT,this.defaultOffset=new BMap.Size(10,10)}function DrawScale(){this.defaultAnchor=BMAP_ANCHOR_BOTTOM_RIGHT,this.defaultOffset=new BMap.Size(10,10)}function drawTips(t){var e=t.left,a=t.right,i=t.top,n=t.ctx;n.beginPath(),n.moveTo(e+8,i-7),n.lineTo(a,i-7),n.lineTo(a,i+7),n.lineTo(e+8,i+7),n.lineTo(e,i),n.fill();var r=n.isPointInPath(t.sup.point.x,t.sup.point.y);r&&(t.sup.hoveredHandle=t),n.save(),n.fillStyle="white",n.fillText(t.text,e+8,i),n.restore()}function DrawTypeControl(t){Class.call(this),t=t||{},this.initOptions($.extend({mapv:null,drawTypeControlOptions:{},layer:null},t)),this.bindTo("drawTypeControlOptions",this.getMapv()),this.mapv=t.mapv,this.defaultAnchor=this.getDrawTypeControlOptions().anchor||BMAP_ANCHOR_TOP_RIGHT,this.defaultOffset=this.getDrawTypeControlOptions().offset||new BMap.Size(10,10)}function OptionalData(t){var e=t.options||{};this.drawType=e.drawType,this["super"]=t,this.options=e.drawOptions||{},this.initCSS(),this.initDom(),this.bindEvent()}function Drawer(t){Class.call(this),this.mapv=t._mapv,this.initOptions({layer:t,map:t.getMap(),ctx:null,mapv:null,animationOptions:{},drawOptions:{size:2}}),this.dataRange=new DataRange(t),this.bindTo("ctx",t),this.bindTo("animationOptions",t),this.bindTo("drawOptions",t),this.bindTo("mapv",t),this.bindTo("map",t)}function BubbleDrawer(){Drawer.apply(this,arguments)}function CategoryDrawer(){Drawer.apply(this,arguments)}function ChoroplethDrawer(){Drawer.apply(this,arguments)}function ClusterDrawer(){Drawer.apply(this,arguments)}function DensityDrawer(){this.Scale,this.masker={},Drawer.apply(this,arguments),this.init()}function recGrids(t,e){for(var a,i,n=t.data,r=t.nwMc,o=t.size,s=t.zoomUnit,l={},h=_this.gridStep=o/s,p=parseInt(r.x/o,10)*o,d=(p-r.x)/s,g=[],c=0;d+c*h<e.getSize().width;){var u=d+c*h;g.push(u.toFixed(2)),c++}for(var f=parseInt(r.y/o,10)*o+o,y=(r.y-f)/s,m=[],v=0;y+v*h<e.getSize().height;)u=y+v*h,m.push(u.toFixed(2)),v++;for(var w=0;w<g.length;w++)for(var x=0;x<m.length;x++){var b=g[w]+"_"+m[x];l[b]=0}for(var w=0;w<n.length;w++){var _=n[w].px,C=n[w].py,D=parseInt(n[w].count,10),S=_<g[0],T=C<m[0],M=_>Number(g[g.length-1])+Number(h),P=C>Number(m[m.length-1])+Number(h);if(!(S||T||M||P)){for(var x=0;x<g.length;x++){var O=Number(g[x]);if(_>=O&&O+h>_)for(var R=0;R<m.length;R++){var L=Number(m[R]);C>=L&&L+h>C&&(l[g[x]+"_"+m[R]]+=D,D=l[g[x]+"_"+m[R]])}}i=i||D,a=a||D,i=i>D?D:i,a=D>a?D:a}}return{grids:l,max:a,min:i}}function drawRec(t){var e=t.size,a=t.zoomUnit,i=t.max,n=t.min,r=t.ctx,o=t.grids,s=(t.fillColors,t.sup),l=formatParam.call(this),h=e/a,p=(i-n+1)/10;for(var d in o){var g=d.split("_"),c=g[0],u=g[1],f=((o[d]-n)/p,t.dataRange.getColorByGradient(o[d]));try{if(l.opacity){var y=parseInt(f.match(/rgba\(.+?\,.+?\,.+?\,(.+?)\)/)[1]*l.opacity)/255;f=f.replace(/(rgba\(.+?\,.+?\,.+?\,).+?(\))/,"$1"+y+"$2")}}catch(m){}var v=s.masker.min&&o[d]<s.masker.min,w=s.masker.max&&o[d]>s.masker.max;0===o[d]||v||w?r.fillStyle="rgba(255,255,255,0.1)":r.fillStyle=f,r.fillRect(c,u,h-1,h-1),s.getDrawOptions().label&&s.getDrawOptions().label.show&&(r.save(),r.textBaseline="top",0===o[d]||v||w||(r.fillStyle="rgba(255,255,255,0.8)",r.textAlign="center",r.textBaseline="middle",r.fillText(o[d],parseInt(c)+h/2,parseInt(u)+h/2)),r.restore())}}function honeycombGrid(t){var e,a,i=t.data,n=t.nwMc,r=t.size,o=t.zoomUnit,s=t.ctx,l={},h=_this.gridStep=r/o,p=_this.depthX=h,d=_this.depthY=3*h/4,g=2*r*3/4,c=parseInt(n.y/g+1,10)*g,u=(n.y-c)/o;u=_this.startY=parseInt(u,10);var f=parseInt(n.x/r,10)*r,y=(f-n.x)/o;y=_this.startX=parseInt(y,10);for(var m=parseInt(s.canvas.width+p,10),v=parseInt(s.canvas.height+d,10),w=y,x=u,b=!1;v>x;){for(;m>w;){var _=b?w-p/2:w;_=parseInt(_,10),l[_+"|"+x]=l[_+"|"+x]||{x:_,y:x,len:0},w+=p}b=!b,w=y,x+=d}for(var C in i){var D=i[C].count,S=i[C].px,T=i[C].py,M=Math.round((T-u)/d),P=M*d+u,O=Math.round((S-y)/p),R=O*p+y;if(M%2&&(R-=p/2),!(y>R||R>m||u>P||P>v)&&l[R+"|"+P]){l[R+"|"+P].len+=D;var L=l[R+"|"+P].len;e=e||L,a=a||L,e=Math.max(e,L),a=Math.min(a,L)}}return{grids:l,max:e,min:a}}function drawHoneycomb(t){var e=formatParam.call(this),a=t.ctx,i=t.grids,n=t.size/t.zoomUnit,r=t.fillColors,o=(t.max-t.min-1)/r.length,s=!1;for(var l in i){var h=i[l].x,p=i[l].y,d=i[l].len,g=d/o|0;g=g>=r.length?r.length-1:g,g=0>g?0:g;var c=t.dataRange.getColorByGradient(d);try{if(e.opacity){var u=parseInt(c.match(/rgba\(.+?\,.+?\,.+?\,(.+?)\)/)[1]*e.opacity)/255;c=c.replace(/(rgba\(.+?\,.+?\,.+?\,).+?(\))/,"$1"+u+"$2")}}catch(f){}var y=t.sup.masker.min&&t.sup.masker.min>d,m=t.sup.masker.max&&t.sup.masker.max<d;d>0&&!y&&!m?draw(h,p,n-1,c,a):s&&draw(h,p,n-1,"rgba(0,0,0,0.4)",a),t.sup.getDrawOptions().label&&t.sup.getDrawOptions().label.show&&!y&&!m&&(0!=d||0!=s)&&(a.save(),a.textBaseline="middle",a.textAlign="center",a.fillStyle="rgba(255,255,255,0.8)",a.fillText(d,h,p),a.restore())}}function draw(t,e,a,i,n){n.beginPath(),n.fillStyle=i,n.moveTo(t,e-a/2),n.lineTo(t+a/2,e-a/4),n.lineTo(t+a/2,e+a/4),n.lineTo(t,e+a/2),n.lineTo(t-a/2,e+a/4),n.lineTo(t-a/2,e-a/4),n.fill(),n.closePath()}function formatParam(){var t=this.getDrawOptions();t=JSON.stringify(t),t=JSON.parse(t);var e=this.fillColors=[[73,174,34],[119,191,26],[160,205,18],[202,221,10],[248,237,1],[225,222,3],[254,182,10],[254,126,19],[254,84,27],[253,54,32]],a=t.size||"50";return a+=t.unit||"px",a=/px$/.test(a)?parseInt(a,10)*this.zoomUnit:parseInt(a,10),t.size=a,t.colors=e,t}function HeatmapDrawer(){var t=this;t.masker={},Drawer.apply(this,arguments),this._max=20,this._data=[]}function IntensityDrawer(){this.masker={min:0,max:0},Drawer.apply(this,arguments),this._tmpCanvas=document.createElement("canvas")}function LineDrawer(){Drawer.apply(this,arguments)}function SimpleDrawer(){Drawer.apply(this,arguments)}var Mapv,util={isPlainObject:function(t){var e,a={},i=a.hasOwnProperty;if(!t||"object"!=typeof t||t.nodeType)return!1;var n=!i.call(t,"constructor"),r=!i.call(t.constructor.prototype,"isPrototypeOf");if(t.constructor&&n&&r)return!1;for(e in t);return void 0===e||i.call(t,e)},extend:function(t,e){var a,i=Object.prototype.toString,n="[object Array]";t=t||{};for(a in e)e.hasOwnProperty(a)&&(util.isPlainObject(e[a])?(t[a]=i.call(e[a])===n?[]:{},util.extend(t[a],e[a]),t[a]=e[a]):t[a]=e[a]);return t},copy:function(t){return this.extend({},t)},inherits:function(t,e){var a,i,n=t.prototype,r=new Function;r.prototype=e.prototype,i=t.prototype=new r;for(a in n)i[a]=n[a];t.prototype.constructor=t,t.superClass=e.prototype},addCssByStyle:function(t){var e=document,a=e.createElement("style");if(a.setAttribute("type","text/css"),a.styleSheet)a.styleSheet.cssText=t;else{var i=e.createTextNode(t);a.appendChild(i)}var n=e.getElementsByTagName("head");n.length?n[0].appendChild(a):e.documentElement.appendChild(a)},getGeoCenter:function(t){for(var e=t[0][0],a=t[0][1],i=t[0][0],n=t[0][1],r=1;r<t.length;r++)e=Math.min(e,t[r][0]),i=Math.max(i,t[r][0]),a=Math.min(a,t[r][1]),n=Math.max(n,t[r][1]);return[e+(i-e)/2,a+(n-a)/2]},getPixelRatio:function(t){var e=t.backingStorePixelRatio||t.webkitBackingStorePixelRatio||t.mozBackingStorePixelRatio||t.msBackingStorePixelRatio||t.oBackingStorePixelRatio||t.backingStorePixelRatio||1;return(window.devicePixelRatio||1)/e}},MVCObject;!function(){function t(t,e){var a=this;a.target=t,a.targetKey=e}t.prototype.transform=function(t,e){var a=this;return a.from=t,a.to=e,a.target.notify(a.targetKey),a},MVCObject=function(){function e(t){return t.substr(0,1).toUpperCase()+t.substr(1)}function a(t){return t[c]||(t[c]=++p)}function i(t){return"_"+t}function n(t){return l.hasOwnProperty(t)?l[t]:l[t]="get"+e(t)}function r(t){return h.hasOwnProperty(t)?h[t]:h[t]="set"+e(t)}function o(t,e){var a=e+"_changed";if(t[a]?t[a]():"function"==typeof t.changed&&t.changed(e),t[d]&&t[d][e]){var i,n,r=t[d][e];for(n in r)r.hasOwnProperty(n)&&(i=r[n],o(i.target,i.targetKey))}}function s(){}var l={},h={},p=0,d="__bindings__",g="__accessors__",c="__uid__",u=s.prototype;return u.get=function(t){var e=this;if(e[g]&&e[g].hasOwnProperty(t)){var a,r=e[g][t],o=r.targetKey,s=r.target,l=n(o);a=s[l]?s[l]():s.get(o),r.to&&(a=r.to(a))}else e.hasOwnProperty(i(t))&&(a=e[i(t)]);return a},u.set=function(t,e){var a=this;if(a[g]&&a[g].hasOwnProperty(t)){var n=a[g][t],s=n.targetKey,l=n.target,h=r(s);n.from&&(e=n.from(e)),l[h]?l[h](e):l.set(s,e)}else this[i(t)]=e,o(a,t);return a},u.changed=function(){},u.notify=function(t){var e=this;if(e[g]&&e[g].hasOwnProperty(t)){var a=e[g][t],i=a.targetKey,n=a.target;n.notify(i)}else o(e,t);return e},u.setValues=function(t){var e,a,i,n=this;for(e in t)t.hasOwnProperty(e)&&(i=t[e],a=r(e),n[a]?n[a](i):n.set(e,i));return n},u.setOptions=u.setValues,u.bindTo=function(e,i,n,r){n||(n=e);var s=this;s.unbind(e),s[g]||(s[g]={}),i[d]||(i[d]={}),i[d][n]||(i[d][n]={});var l=new t(s,e),h=new t(i,n);return s[g][e]=h,i[d][n][a(s)]=l,r||o(s,e),h},u.unbind=function(t){var e=this;if(e[g]){var n=e[g][t];if(n){var r=n.target,o=n.targetKey;e[i(t)]=e.get(t),delete r[d][o][a(e)],delete e[g][t]}}return e},u.unbindAll=function(){var t=this;if(t[g]){var e=t[g];for(var a in e)e.hasOwnProperty(a)&&t.unbind(a)}return t},u.initOptions=function(t){for(var e in t)this[n(e)]=function(t){return function(){return this.get(t)}}(e),this[r(e)]=function(t){return function(e){this.set(t,e)}}(e),this[i(e)]=t[e]},s}()}(),Mapv.MVCObject=MVCObject,util.inherits(Class,MVCObject),Class.prototype.addEventListener=function(t,e){return"object"!=typeof this.__listeners[t]&&(this.__listeners[t]=[]),this.__listeners[t].push(e),this},Class.prototype.removeEventListener=function(t,e){var a=this.__listeners[t];if(!a)return!1;for(var i=a.length;i>=0;i--)a[i]===e&&a.splice(i,1);return this},Class.prototype.dispatchEvent=function(t,e){var a=util.extend({},e),i=this.__listeners[t];if(!i)return!1;for(var n=i.length-1;n>=0;n--)i[n].call(this,a);return this},Class.prototype.dispose=function(){},util.inherits(DataRange,Class),util.extend(DataRange.prototype,{defaultGradient:{.4:"blue",.6:"cyan",.7:"lime",.8:"yellow","1.0":"red"},colors:["rgba(17, 102, 252, 0.8)","rgba(52, 139, 251, 0.8)","rgba(110, 176, 253, 0.8)","rgba(255, 241, 193, 0.8)","rgba(255, 146, 149, 0.8)","rgba(253, 98, 104, 0.8)","rgba(255, 0, 0, 0.8)","rgba(255, 51, 61, 0.8)"],getSize:function(t){for(var e=1,a=this.splitList,i=0;i<a.length;i++)if((void 0===a[i].start||void 0!==a[i].start&&t>=a[i].start)&&(void 0===a[i].end||void 0!==a[i].end&&t<a[i].end)){e=a[i].size;break}return e},getColorByRange:function(t){for(var e="rgba(50, 50, 255, 1)",a=this.splitList,i=0;i<a.length;i++)if((void 0===a[i].start||void 0!==a[i].start&&t>=a[i].start)&&(void 0===a[i].end||void 0!==a[i].end&&t<a[i].end)){e=a[i].color;break}return e},data_changed:function(){var t=this.get("data");if(t&&t.length>0){this._min=t[0].count,this._max=t[0].count;for(var e=0;e<t.length;e++)this._max=Math.max(this._max,t[e].count),this._min=Math.min(this._min,t[e].count)}},drawType_changed:function(){this.update()},drawOptions_changed:function(){this.update()},update:function(){var t=this.get("drawOptions");t&&t.splitList?this.splitList=t.splitList:this.generalSplitList(),"category"===this.get("layer").getDrawType()&&(t&&t.splitList?this.categorySplitList=t.splitList:this.generalCategorySplitList()),("heatmap"===this.get("layer").getDrawType()||"density"===this.get("layer").getDrawType()||"intensity"===this.get("layer").getDrawType())&&this.generalGradient(t.gradient||this.defaultGradient),this.draw()},draw:function(){this.get("layer").getDataRangeControl()&&this.get("layer").dataRangeControl.show(),"bubble"===this.get("layer").getDrawType()?this.get("layer").dataRangeControl.drawSizeSplit(this.splitList,this.get("drawOptions")):"category"===this.get("layer").getDrawType()?this.get("layer").dataRangeControl.drawCategorySplit(this.categorySplitList,this.get("drawOptions")):"choropleth"===this.get("layer").getDrawType()?this.get("layer").dataRangeControl.drawChoroplethSplit(this.splitList,this.get("drawOptions")):this.get("layer").dataRangeControl.hide()},generalSplitList:function(){var t=Math.ceil((this._max-this._min)/7),e=this._min;this.splitList=[];for(var a=1;e<this._max;)this.splitList.push({start:e,end:e+t,size:a,color:this.colors[a-1]}),e+=t,a++},generalCategorySplitList:function(){var t=["rgba(255, 255, 0, 0.8)","rgba(253, 98, 104, 0.8)","rgba(255, 146, 149, 0.8)","rgba(255, 241, 193, 0.8)","rgba(110, 176, 253, 0.8)","rgba(52, 139, 251, 0.8)","rgba(17, 102, 252, 0.8)"],e=this.get("data");this.categorySplitList={};for(var a=0,i=0;i<e.length&&(void 0===this.categorySplitList[e[i].count]&&(this.categorySplitList[e[i].count]=t[a],a++),!(a>=t.length-1));i++);this.categorySplitList.other=t[t.length-1]},getCategoryColor:function(t){var e=this.categorySplitList,a=e.other;for(var i in e)if(t==i){a=e[i];break}return a},generalGradient:function(t){var e=document.createElement("canvas"),a=e.getContext("2d"),i=a.createLinearGradient(0,0,0,256);e.width=1,e.height=256;for(var n in t)i.addColorStop(n,t[n]);a.fillStyle=i,a.fillRect(0,0,1,256),this._grad=a.getImageData(0,0,1,256).data},getGradient:function(){return this._grad},getColorByGradient:function(t){var e=this.get("max")||10,a=t/e;a>1&&(a=1),a*=255,a=parseInt(a,10),a*=4;var i="rgba("+this._grad[a]+", "+this._grad[a+1]+", "+this._grad[a+2]+","+this._grad[a+3]+")";return i}}),Animation.INFINITE="INFINITE",Animation.prototype.start=function(){this._beginTime=getCurrentTime(),this._endTime=this._beginTime+this._opts.duration,this._launch()},Animation.prototype.add=function(t){this._anis.push(t)},Animation.prototype._launch=function(){var t=this,e=getCurrentTime();if(e>=t._endTime){if(t._opts.render&&t._opts.render(t._opts.transition(1)),t._opts.finish&&t._opts.finish(),t._anis.length>0){var a=t._anis[0];a._anis=[].concat(t._anis.slice(1)),a.start()}}else t.schedule=t._opts.transition((e-t._beginTime)/t._opts.duration),t._opts.render&&t._opts.render(t.schedule),t.terminative||(t._timer=setTimeout(function(){t._launch()},1e3/t._opts.fps))},Animation.prototype.stop=function(t){this.terminative=!0;for(var e=0;e<this._anis.length;e++)this._anis[e].stop(),this._anis[e]=null;this._anis.length=0,this._timer&&(clearTimeout(this._timer),this._timer=null),this._opts.onStop(this.schedule),t&&(this._endTime=this._beginTime,this._launch())},Animation.prototype.cancel=function(){this._timer&&clearTimeout(this._timer),this._endTime=this._beginTime,this.schedule=0},Animation.prototype.setFinishCallback=function(t){this._anis.length>0?this._anis[this._anis.length-1]._opts.finish=t:this._opts.finish=t};var Transitions={linear:function(t){return t},reverse:function(t){return 1-t},easeInQuad:function(t){return t*t},easeInCubic:function(t){return Math.pow(t,3)},easeOutQuad:function(t){return-(t*(t-2))},easeOutCubic:function(t){return Math.pow(t-1,3)+1},easeInOutQuad:function(t){return.5>t?t*t*2:-2*(t-2)*t-1},easeInOutCubic:function(t){return.5>t?4*Math.pow(t,3):4*Math.pow(t-1,3)+1},easeInOutSine:function(t){return(1-Math.cos(Math.PI*t))/2}};Transitions["ease-in"]=Transitions.easeInQuad,Transitions["ease-out"]=Transitions.easeOutQuad,util.inherits(SizeDataRange,DataRange),util.extend(SizeDataRange.prototype,{}),util.inherits(TimeLine,Class),util.extend(TimeLine.prototype,{});var timeLine=new TimeLine({});util.inherits(Mapv,Class),Mapv.prototype._initDrawScale=function(){this.Scale=new DrawScale},Mapv.prototype.drawTypeControl_changed=function(){this.getDrawTypeControl()?(this.drawTypeControl||(this.drawTypeControl=new DrawTypeControl({mapv:this})),this.getMap().addControl(this.drawTypeControl)):this.drawTypeControl&&this.getMap().removeControl(this.drawTypeControl)};var MapEvent_id=0,MapEvent_events={mousemove:{},click:{}};MapEvent.prototype.addEvent=function(t,e){MapEvent_events[t][MapEvent_id++]=e},MapEvent.prototype.removeEvent=function(t){delete MapEvent_events[type][t]},CanvasLayer.prototype=new BMap.Overlay,CanvasLayer.prototype.initialize=function(t){this._map=t;var e=this.canvas=document.createElement("canvas");e.style.cssText="position:absolute;left:0;top:0;z-index:"+this.zIndex+";",this.adjustSize(),t.getPanes()[this.paneName].appendChild(e);var a=this;return t.addEventListener("resize",function(){a.adjustSize(),a.draw()}),this.canvas},CanvasLayer.prototype.adjustSize=function(){var t,e=this._map.getSize(),a=this.canvas;t="webgl"==this.context?1:function(t){var e=t.backingStorePixelRatio||t.webkitBackingStorePixelRatio||t.mozBackingStorePixelRatio||t.msBackingStorePixelRatio||t.oBackingStorePixelRatio||t.backingStorePixelRatio||1;return(window.devicePixelRatio||1)/e}(a.getContext("2d")),a.width=e.width*t,a.height=e.height*t,a.style.width=e.width+"px",a.style.height=e.height+"px"},CanvasLayer.prototype.draw=function(){var t=this._map,e=t.getSize(),a=t.getCenter();if(a){var i=t.pointToOverlayPixel(a);this.canvas.style.left=i.x-e.width/2+"px",this.canvas.style.top=i.y-e.height/2+"px",this.dispatchEvent("draw"),this.options.update&&this.options.update.call(this)}},CanvasLayer.prototype.getContainer=function(){return this.canvas},CanvasLayer.prototype.show=function(){this.canvas||this._map.addOverlay(this),this.canvas.style.display="block"},CanvasLayer.prototype.hide=function(){this.canvas.style.display="none"},CanvasLayer.prototype.setZIndex=function(t){this.canvas.style.zIndex=t},CanvasLayer.prototype.getZIndex=function(){return this.zIndex},util.inherits(Layer,Class),util.extend(Layer.prototype,{initialize:function(){if(!this.canvasLayer){this.bindTo("map",this.getMapv()),this.getMap().addControl(this.dataRangeControl),this.getMap().addControl(this.Scale);var t=this;this.canvasLayer=new CanvasLayer({map:this.getMap(),context:this.getContext(),zIndex:this.getZIndex(),paneName:this.getPaneName(),update:function(){t.draw()},elementTag:"canvas"}),this.setCtx(this.canvasLayer.getContainer().getContext(this.getContext())),this.getAnimation()&&(this.animationLayer=new CanvasLayer({map:this.getMap(),zIndex:this.getZIndex(),elementTag:"canvas"}),this.setAnimationCtx(this.animationLayer.getContainer().getContext(this.getContext())))}},draw:function(){var t=this;if(this.getMapv()){var e=this.getCtx();if(!e)return!1;this._calculatePixel(),"time"!==this.getAnimation()&&("2d"==this.getContext()&&e.clearRect(0,0,e.canvas.width,e.canvas.height),this._getDrawer().drawMap()),"polyline"===this.getDataType()&&this.getAnimation()&&!this._animationFlag&&(this.drawAnimation(),this._animationFlag=!0);var a=this.getAnimationOptions()||{};if("polyline"===this.getDataType()&&this.getAnimation()&&!this._animationTime){this._animationTime=!0;var i=this.timeline=new Animation({duration:a.duration||1e4,fps:a.fps||30,delay:a.delay||Animation.INFINITE,transition:Transitions[a.transition||"linear"],onStop:a.onStop||function(t){},render:function(i){"2d"==t.getContext()&&e.clearRect(0,0,e.canvas.width,e.canvas.height);var n=parseInt(parseFloat(t._minTime)+(t._maxTime-t._minTime)*i);t._getDrawer().drawMap(n),a.render&&a.render(n)}});i.setFinishCallback(function(){i.start()}),i.start()}this.dispatchEvent("draw")}},drawAnimation:function(){var t=this.getAnimationCtx();if(!t)return!1;t.clearRect(0,0,t.canvas.width,t.canvas.height);var e=this;this._getDrawer().drawAnimation(),this.getAnimation()&&requestAnimationFrame(function(){e.drawAnimation()})},animation_changed:function(){this.getAnimation()&&this.drawAnimation()},mapv_changed:function(){return this.getMapv()?(this.canvasLayer&&this.canvasLayer.show(),this.initialize(),this.updateControl(),void this.draw()):void(this.canvasLayer&&this.canvasLayer.hide())},drawType_changed:function(){this.updateControl(),this.draw()},drawOptions_changed:function(){this.draw()},updateControl:function(){var t=this.getMapv();if(t){var e=this._getDrawer();this.getMap();e.scale&&this.getDataRangeControl()?(e.scale(this.Scale),this.Scale.show()):this.Scale.hide(),this.getMapv().OptionalData&&this.getMapv().OptionalData.initController(this,this.getDrawType())}},_getDrawer:function _getDrawer(){var drawType=this.getDrawType();if(!this._drawer[drawType]){var funcName=drawType.replace(/(\w)/,function(t){return t.toUpperCase()});funcName+="Drawer";var drawer=this._drawer[drawType]=eval("(new "+funcName+"(this))");drawer.scale?this.getMapv()&&(drawer.scale(this.Scale),this.Scale.show()):this.Scale.hide()}return this._drawer[drawType]},_calculatePixel:function(){for(var t=this.getMapv().getMap(),e=t.getMapType().getProjection(),a=t.getZoom(),i=Math.pow(2,18-a),n=e.lngLatToPoint(t.getCenter()),r=new BMap.Pixel(n.x-t.getSize().width/2*i,n.y+t.getSize().height/2*i),o=this.getData(),t=this.getMap(),s=0;s<o.length;s++){if(o[s].lng&&o[s].lat&&!o[s].x&&!o[s].y){var l=e.lngLatToPoint(new BMap.Point(o[s].lng,o[s].lat));o[s].x=l.x,o[s].y=l.y}if(o[s].x&&o[s].y&&(o[s].px=(o[s].x-r.x)/i,o[s].py=(r.y-o[s].y)/i),o[s].geo){var h=[];if("bd09ll"===this.getCoordType())for(var p=0;p<o[s].geo.length;p++){var l=t.pointToPixel(new BMap.Point(o[s].geo[p][0],o[s].geo[p][1]));h.push([l.x,l.y,parseFloat(o[s].geo[p][2])])}else if("bd09mc"===this.getCoordType())for(var p=0;p<o[s].geo.length;p++)h.push([(o[s].geo[p][0]-r.x)/i,(r.y-o[s].geo[p][1])/i,parseFloat(o[s].geo[p][2])]);o[s].pgeo=h}}},data_changed:function(){var t=this.getData();if(t){if("polyline"===this.getDataType()&&this.getAnimation())for(var e=0;e<t.length;e++)t[e].index=parseInt(Math.random()*t[e].geo.length,10);if("polyline"===this.getDataType()&&"time"===this.getAnimation()){this._minTime=t[0]&&t[0].geo[0][2],this._maxTime=this._minTime;for(var e=0;e<t.length;e++)for(var a=t[e].geo,i=0;i<a.length;i++){var n=a[i][2];n<this._minTime&&(this._minTime=n),n>this._maxTime&&(this._maxTime=n)}}t.length>0&&(this._min=t[0].count,this._max=this._max);for(var e=0;e<t.length;e++)(void 0===t[e].count||null===t[e].count)&&(t[e].count=1),this._max=Math.max(this._max,t[e].count),this._min=Math.min(this._min,t[e].count);this.draw()}},getDataRange:function(){return{minTime:this._minTime,maxTime:this._maxTime,min:this._min,max:this._max}},zIndex_changed:function(){var t=this.getZIndex();this.canvasLayer.setZIndex(t)},dataRangeControl_changed:function(){this.updateControl(),this._getDrawer().notify("drawOptions")}}),DataControl.prototype.initDom=function(){var t=this.control=document.createElement("div"),e=this.input=document.createElement("input");e.type="file";var a=document.createElement("div");a.textContent="自定义数据：";var i=document.createElement("div");i.textContent="拖拽文件到窗口或者选择自定义文件",t.appendChild(a),t.appendChild(i),t.appendChild(e),t.style.fontSize="12px",t.style.lineHeight="1.8em",t.style.position="absolute",t.style.bottom="50px",t.style.left="10px",t.style.padding="10px 20px",t.style.color="#FFF",t.style.background="rgba(0,0,0,0.5)",t.style.zIndex="100000",t.style.overflow="hidden",t.style.webkitTransition="all 0.5s ease-in";var n=document.createElement("div"),r=document.createElement("div");r.textContent="历史数据",this.history=document.createElement("div"),n.appendChild(r),n.appendChild(this.history),t.appendChild(n),document.body.appendChild(t)},DataControl.prototype.initEvent=function(){function t(t){var a,i=!1;try{a=JSON.parse(t.replace(/\s/g,""));for(var n=0;"string"==typeof a&&10>=n;)a=JSON.parse(a),n++;i=!1}catch(r){i=!0}if(i)try{a=[];var o=t.split("\n");o.length<=1&&(o=t.split("\\n"));for(var s=o[0].split(","),l=1;l<s.length;l++){for(var h=o[l].split(","),p={},d=0,g=0;g<h.length;g++){var c=s[g]||"noname"+d++;c=c.replace(/\\r/g,""),p[c]=Number(h[g].replace(/\\r/g,"").replace(/\"/g,""))}a.push(p)}a=JSON.stringify(a).replace(/\\r/g,""),a=JSON.parse(a),i=!1}catch(r){i=!0}if(i)return!1;e.geoData.setData(a);for(var l=0;l<e["super"]._layers.length;l++)e["super"]._layers[l].draw();return!0}var e=this,a=new FileReader;a.addEventListener("load",function(i){var n=a.result,r=t(n);if(r){var o=localStorage.getItem("filenames")||"{}";if(o=JSON.parse(o),!a.fileName||!a.fileSize)return!1;for(var s in o)if(o[s].name===this.fileName&&o[s].size===this.fileSize)return!1;var l=this.fileName+this.fileSize+parseInt(1e17*Math.random(),10).toString(36);o[l]={size:this.fileSize,name:this.fileName},localStorage.setItem("filenames",JSON.stringify(o)),localStorage.setItem(l,JSON.stringify(n)),e.initHistory()}}),e.history.addEventListener("click",function(e){var a=e.target;if("A"===a.nodeName){var i=a.getAttribute("storageName"),n=localStorage.getItem(i);t(n)}return!1}),e.input.addEventListener("change",function(t){a.readAsText(t.target.files[0]),a.fileName=t.target.files[0].name,a.fileSize=t.target.files[0].size}),document.addEventListener("dragover",function(t){t.preventDefault()},!1),document.addEventListener("drop",function(t){return t.preventDefault(),a.readAsText(t.dataTransfer.files[0]),a.fileName=t.dataTransfer.files[0].name,a.fileSize=t.dataTransfer.files[0].size,!1})},DataRangeControl.prototype=new BMap.Control,util.extend(DataRangeControl.prototype,{initialize:function(t){var e=this.canvas=document.createElement("canvas");return e.style.background="#fff",e.style.boxShadow="rgba(0,0,0,0.2) 0 0 4px 2px",e.style.border="1px solid #999999",e.style.borderRadius="4px",t.getContainer().appendChild(e),e},getContainer:function(){return this.canvas},drawSizeSplit:function(t,e){var a=this.canvas;a.width=100,a.height=190,a.style.width="100px",a.style.height="190px";for(var i=a.getContext("2d"),n=10,r=0,o=0;o<t.length;o++)t[o].size>r&&(r=t[o].size);for(var o=0;o<t.length;o++){n+=t[o].size,i.beginPath(),i.arc(r+5,n,t[o].size,0,2*Math.PI,!1);var s=t[o].start||"~",l=t[o].end||"~",h=s+" - "+l;i.closePath(),i.fillStyle=e.fillStyle||"rgba(50, 50, 200, 0.8)",i.fill(),i.fillStyle="rgba(30, 30, 30, 1)",i.fillText(h,2*r+10,n+6);var p=t[o].size+5;15>p&&(p=15),n+=p}},drawCategorySplit:function(t,e){var a=this.canvas;a.width=80,a.height=190,a.style.width="80px",a.style.height="190px";var i=a.getContext("2d"),n=0;for(var r in t)i.fillStyle=t[r],i.beginPath(),i.arc(15,25*n+15,5,0,2*Math.PI,!1),i.closePath(),i.fill(),i.fillStyle="#333",i.fillText(r,25,25*n+20),n++},drawChoroplethSplit:function(t,e){var a=this.canvas;a.width=100,a.height=190,a.style.width="100px",a.style.height="190px";var i=a.getContext("2d");i.fillStyle=e.fillStyle||"rgba(50, 50, 200, 0.8)";for(var n=0;n<t.length;n++){i.beginPath(),i.arc(15,25*n+15,5,0,2*Math.PI,!1);var r=(t[n].start||"~")+" - "+(t[n].end||"~");i.closePath(),i.fillStyle=t[n].color,i.fill(),i.fillStyle="#333",i.fillText(r,25,25*n+20)}},hide:function(){this.canvas&&(this.canvas.style.display="none")},show:function(){this.canvas&&(this.canvas.style.display="block")}}),DrawScale.prototype=new BMap.Control,DrawScale.prototype.change=function(t){var e=this;e.changeFn=t},DrawScale.prototype.hide=function(){var t=this;t.box.style.display="none"},DrawScale.prototype.show=function(){var t=this;t.box&&(t.box.style.display="block")},DrawScale.prototype.set=function(t){var e=this;e.max=t.max||e.max,e.min=t.min||e.min,e.colors=t.colors||e.colors,e._draw()},DrawScale.prototype.initialize=function(t){var e=this;e.changeFn=null,e.width=55,e.height=250,e.min=0,e.max=100,e.offsetTop=10,e.offsetBottom=10,e.drawHeight=e.height-e.offsetTop-e.offsetBottom,e.colors=["#49ae22","#77c01a","#a0cd12","#cadd0a","#f8ed01","#e1de03","#feb60a","#fe7e13","#fe571b","#fd3620"],e.defaultColors=["#49ae22","#77c01a","#a0cd12","#cadd0a","#f8ed01","#e1de03","#feb60a","#fe7e13","#fe571b","#fd3620"],e.point={x:0,y:0},e.hoveredHandle=null,e.showHandle=!1,e.handleStartPos={val:e.min,yMin:e.offsetTop,yMax:e.offsetTop+e.drawHeight,y:e.offsetTop},e.handleEndPos={val:e.max,yMin:e.offsetTop,yMax:e.offsetTop+e.drawHeight,y:e.offsetTop+e.drawHeight};var a=e.box=document.createElement("div"),i=document.createElement("canvas");return i.width=e.width,i.height=e.height,i.style.cursor="pointer",a.style.border="1px solid #999",a.style.boxShadow="rgba(0, 0, 0, 0.2) 0px 0px 4px 2px",a.style.borderRadius="6px",a.style.background="white",a.style.position="absolute",a.style.width=e.width+"px",a.style.height=e.height+"px",a.style.zIndex=1e4,a.appendChild(i),t.getContainer().appendChild(a),e.ctx=i.getContext("2d"),e._draw(),this._Event(),a},DrawScale.prototype._Event=function(){var t=this,e=t.ctx.canvas,a=!1,i={x:0,y:0},n={y:0,name:null};e.addEventListener("mouseenter",function(){t.showHandle=!0,t._draw()}),e.addEventListener("mouseleave",function(){t.showHandle=!1,t._draw()}),e.addEventListener("mousedown",function(e){var r=t.hoveredHandle;if(r){i.x=e.pageX,i.y=e.pageY;var o="handle"+r.name+"Pos";n.name=o,n.y=t[o].y,a=!0}}),window.addEventListener("mousemove",function(e){if(t.point.x=e.offsetX,t.point.y=e.offsetY,a){var r=e.pageY-i.y;t[n.name].y=n.y+r;var o=n.y+r,s=t[n.name].yMax,l=t[n.name].yMin;o=o>s?s:o,o=l>o?l:o,t[n.name].y=o,"handleStartPos"===n.name&&(t.handleEndPos.yMin=o),"handleEndPos"===n.name&&(t.handleStartPos.yMax=o),e.preventDefault()}t._draw()}),window.addEventListener("mouseup",function(e){a&&(t.changeFn&&t.changeFn(t.handleStartPos.val,t.handleEndPos.val),a=!1)})},DrawScale.prototype._draw=function(){var t=this,e=t.ctx;if(e){e.clearRect(0,0,e.canvas.width,e.canvas.height),t.hoveredHandle=null;var a,i=5,n=t.offsetTop,r=10,o=t.drawHeight;a="default"===t.colors?t.defaultColors:t.colors;var s=e.createLinearGradient(i,n,r,o),l=o/(a.length-1);if(t.colors instanceof Array||"default"===t.colors)for(var h=0;h<a.length;h++){var p=h*l/t.height;s.addColorStop(p,a[h])}else if("object"==typeof t.colors)for(var h in t.colors)s.addColorStop(h,t.colors[h]);e.fillStyle=e.strokeStyle=s,e.fillRect(i,n,r,o);var d=(t.handleStartPos.y-n)/o*t.max|0,g=t.handleStartPos.val=d+t.min,c=t.handleEndPos.val=(t.handleEndPos.y-n)/o*t.max|0;e.textAlign="left",e.textBaseline="middle";var u=i+r+5;e.fillText("- "+t.min,u,n),e.fillText("- "+t.max,u,n+o),e.save(),e.fillStyle="grey",t.handleStartPos.y>n+10&&e.fillText("- "+g,u,t.handleStartPos.y),t.handleEndPos.y<n+o-10&&e.fillText("- "+c,u,t.handleEndPos.y),e.restore(),t.showHandle&&(drawTips({sup:t,name:"Start",ctx:e,left:i+r,right:e.canvas.width-5,top:t.handleStartPos.y,text:g}),drawTips({sup:t,name:"End",ctx:e,left:i+r,right:e.canvas.width-5,top:t.handleEndPos.y,text:c})),e.save(),e.fillStyle="#ADABAB";var f=i,y=r;e.fillRect(f,n,y,t.handleStartPos.y-t.offsetTop),e.fillRect(f,t.handleEndPos.y,y,o-t.handleEndPos.y+t.offsetTop),e.restore(),t.hoveredHandle?e.canvas.style.cursor="pointer":e.canvas.style.cursor="default";
}},util.addCssByStyle(["#MapvDrawTypeControl { list-style:none; position:absolute; right:0px; top:0px; bottom:0px; padding:0; margin:0;","border-radius: 5px; overflow: hidden; border: 1px solid rgb(153, 153, 153); box-shadow: rgba(0, 0, 0, 0.2) 0px 0px 4px 2px;}","#MapvDrawTypeControl li{ padding:0; margin:0; cursor:pointer; ","color:#333; padding:5px; background:rgba(255, 255, 255, 1); border-bottom: 1px solid #aaa;}","#MapvDrawTypeControl li.current{ background:#999; color:#fff;}"].join("\n")),util.inherits(DrawTypeControl,Class),util.inherits(DrawTypeControl,BMap.Control),DrawTypeControl.prototype.initialize=function(t){var e=this.ul=document.createElement("ul");e.setAttribute("id","MapvDrawTypeControl");var a=this;return e.addEventListener("click",function(t){var e=t.target;if("LI"===e.nodeName){for(var i=e.parentNode,n=i.getElementsByTagName("li"),r=0;r<n.length;r++)n[r].className="";var o=e.getAttribute("drawType");e.className="current",a.getDrawTypeControlOptions().drawOptions&&a.getDrawTypeControlOptions().drawOptions[o]&&a.layer.setDrawOptions(a.getDrawTypeControlOptions().drawOptions[o]),a.layer.setDrawType(o)}}),this.showLayer(),t.getContainer().appendChild(e),e},DrawTypeControl.prototype.getContainer=function(){return this.ul},DrawTypeControl.prototype.drawTypeControlOptions_changed=function(){this.layer=this.getDrawTypeControlOptions().layer,this.layer&&(this.showLayer(),void 0!==this.getDrawTypeControlOptions().anchor&&this.setAnchor(this.getDrawTypeControlOptions().anchor),void 0!==this.getDrawTypeControlOptions().offset&&this.setOffset(this.getDrawTypeControlOptions().offset))},DrawTypeControl.prototype.showLayer=function(){if(this.layer){var t=this.ul;t.innerHTML="";for(var e=["simple","heatmap","density","bubble","category","choropleth","intensity","cluster"],a=0;a<e.length;a++){var i=e[a],n=document.createElement("li");this.layer.getDrawType()===i&&(n.className="current"),n.setAttribute("drawType",i),n.innerHTML=i,t.appendChild(n)}}},OptionalData.prototype.initCSS=function(){util.addCssByStyle([".controlBox { position:absolute; left:0px; top:0px; background:rgba(0,0,0,0.5); padding:10px; }",".controlBox input {border-radius:6px; border:none; padding:10px;}",".controlBox button ","{ padding:8px 10px; border:none; width:40%; margin-left: 10px; border-radius:6px; cursor:pointer; }",".controlBoxBlock { color:#fff; padding: 10px; }",".controlBoxTitle { display:inline-block; width:100px; text-align:right; padding-right:10px; }"].join("\n"))},OptionalData.prototype.initDom=function(){var t=this.box=document.createElement("div");t.className="controlBox";var e=this.contentBox=document.createElement("div"),a=document.createElement("div");a.style.textAlign="center";var i=this.updateBtn=document.createElement("button"),n=this.resetBtn=document.createElement("button");return i.textContent="update",n.textContent="reset",t.appendChild(e),a.appendChild(i),a.appendChild(n),t.appendChild(a),document.body.appendChild(t),t},OptionalData.prototype.initController=function(t,e){return!1},OptionalData.prototype.bindEvent=function(){var t=this;this.updateBtn.onclick=function(){for(var e=0;e<t.options.editable.length;e++){var a=t.options.editable[e].name,i=t.contentBox.querySelector('input[name="'+a+'"]');i&&("radio"===i.type?(i=t.contentBox.querySelector('input[name="'+a+'"]:checked'),t.options[a]=i.value):"checkbox"===i.type?(i=t.contentBox.querySelector('input[name="'+a+'"]'),t.options[a]=i.checked):"true"===i.getAttribute("isJson")?t.options[a]=JSON.parse(i.value):t.options[a]=i.value)}var n=t._layer._getDrawer(t.drawType);n.setDrawOptions(t.options),t._layer.draw()},this.resetBtn.onclick=function(){for(var e=0;e<t.options.editable.length;e++){var a=t.options.editable[e].name,i=t.options.editable[e]._oldVal;t.options[a]=i}var n=this._layer._getDrawer(t.drawType);n.setDrawOptions(t.options),this._layer.draw(),t.initController()}},util.inherits(Drawer,Class),Drawer.prototype.beginDrawMap=function(){"2d"==this.getLayer().getContext()&&this.beginDrawCanvasMap()},Drawer.prototype.endDrawMap=function(){"2d"==this.getLayer().getContext()&&this.endDrawCanvasMap()},Drawer.prototype.beginDrawCanvasMap=function(){var t=this.getDrawOptions(),e=this.getCtx(),a=util.getPixelRatio(e);e.save(),e.scale(a,a);for(var i=["globalCompositeOperation","shadowColor","shadowBlur","shadowOffsetX","shadowOffsetY","globalAlpha","fillStyle","strokeStyle","lineWidth","lineCap","lineJoin","lineWidth","miterLimit"],n=0;n<i.length;n++)t[i[n]]&&(e[i[n]]=t[i[n]])},Drawer.prototype.endDrawCanvasMap=function(){var t=this.getCtx();t.restore()},Drawer.prototype.drawOptions_changed=function(){var t=this.getDrawOptions();t&&t.splitList?this.splitList=t.splitList:this.generalSplitList()},Drawer.prototype.colors=["rgba(17, 102, 252, 0.8)","rgba(52, 139, 251, 0.8)","rgba(110, 176, 253, 0.8)","rgba(255, 241, 193, 0.8)","rgba(255, 146, 149, 0.8)","rgba(253, 98, 104, 0.8)","rgba(255, 0, 0, 0.8)","rgba(255, 51, 61, 0.8)"],Drawer.prototype.generalSplitList=function(){var t=this.getLayer().getDataRange(),e=Math.ceil((t.max-t.min)/7),a=t.min;this.splitList=[];for(var i=1;a<t.max;)this.splitList.push({start:a,end:a+e,size:i,color:this.colors[i-1]}),a+=e,i++},Drawer.prototype.getRadius=function(){var t=this.getMap().getZoom(),e=Math.pow(2,18-t),a=this.getDrawOptions(),i=parseFloat(a.size)||13,n=a.unit||"px";return"m"===n?i/=e:i=i,a.minPxSize&&i<a.minPxSize&&(i=a.minPxSize),i},util.inherits(BubbleDrawer,Drawer),BubbleDrawer.prototype.drawMap=function(){this.beginDrawMap();for(var t=this.getLayer().getData(),e=this.getCtx(),a=this.getDrawOptions(),i=0,n=t.length;n>i;i++){var r=t[i],o=this.dataRange.getSize(r.count);e.beginPath(),e.arc(r.px,r.py,o,0,2*Math.PI,!1),e.closePath(),e.fill(),a.strokeStyle&&e.stroke()}this.endDrawMap()},util.inherits(CategoryDrawer,Drawer),CategoryDrawer.prototype.drawMap=function(){this.beginDrawMap();for(var t=this.getLayer().getData(),e=this.getCtx(),a=this.getDrawOptions(),i=this.getRadius(),n=0,r=t.length;r>n;n++){var o=t[n];e.beginPath(),e.moveTo(o.px,o.py),e.fillStyle=this.dataRange.getCategoryColor(o.count),e.arc(o.px,o.py,i,0,2*Math.PI),e.closePath(),e.fill()}a.strokeStyle&&e.stroke(),this.endDrawMap()},util.inherits(ChoroplethDrawer,Drawer),ChoroplethDrawer.prototype.drawMap=function(){this.beginDrawMap();var t=this.getLayer().getData(),e=this.getLayer().getDataType(),a=this.getCtx(),i=this.getDrawOptions(),n=i.label,r=this.getMap().getZoom();if(n&&n.font&&(a.font=n.font),"polyline"===e||"polygon"===e)for(var o=0,s=t.length;s>o;o++){var l=t[o].pgeo;a.beginPath(),a.moveTo(l[0][0],l[0][1]);for(var h=1;h<l.length;h++)a.lineTo(l[h][0],l[h][1]);if(a.fillStyle=this.dataRange.getColorByRange(t[o].count),(i.strokeStyle||"polyline"===e)&&a.stroke(),"polygon"===e&&(a.closePath(),a.fill()),n&&n.show&&(!n.minZoom||n.minZoom&&r>=n.minZoom)){n.fillStyle&&(a.fillStyle=n.fillStyle);var p=util.getGeoCenter(l);a.fillText(t[o].count,p[0],p[1])}}else{for(var d=this.getRadius(),o=0,s=t.length;s>o;o++){var g=t[o];a.fillStyle=this.dataRange.getColorByRange(g.count),a.beginPath(),a.moveTo(g.px,g.py),a.arc(g.px,g.py,d,0,2*Math.PI),a.closePath(),a.fill()}i.strokeStyle&&a.stroke()}this.endDrawMap()};var min,max;util.inherits(ClusterDrawer,Drawer),ClusterDrawer.prototype.drawMap=function(){this.beginDrawMap();var t=this.getCtx();max=min=void 0;for(var e=this.getLayer().getData(),a=this.getMapv().getMap(),i=a.getZoom(),n=this.zoomUnit=Math.pow(2,18-i),r=this.formatParam(),o=r.size,s=a.getMapType().getProjection(),l=s.lngLatToPoint(a.getCenter()),h=l.x-a.getSize().width/2*n,p=new BMap.Pixel(h,l.y+a.getSize().height/2*n),d=o/n,g=parseInt(p.x/o,10)*o,c=(g-p.x)/n,u=[],f=0;c+f*d<a.getSize().width;){var y=c+f*d;u.push(y.toFixed(2)),f++}for(var m=parseInt(p.y/o,10)*o+o,v=(p.y-m)/n,w=[],x=0;v+x*d<a.getSize().height;)y=v+x*d,w.push(y.toFixed(2)),x++;for(var b={},_=0;_<u.length;_++)for(var C=0;C<w.length;C++){var D=u[_]+"_"+w[C];b[D]=0}for(var _=0;_<e.length;_++){var S=e[_].px,T=e[_].py,M=parseInt(e[_].count,10),P=S<u[0],O=T<w[0],R=S>Number(u[u.length-1])+Number(d),L=T>Number(w[w.length-1])+Number(d);if(!(P||O||R||L)){for(var C=0;C<u.length;C++){var I=Number(u[C]);if(S>=I&&I+d>S)for(var k=0;k<w.length;k++){var z=Number(w[k]);T>=z&&z+d>T&&(b[u[C]+"_"+w[k]]+=M,M=b[u[C]+"_"+w[k]])}}min=min||M,max=max||M,min=min>M?M:min,max=M>max?M:max}}var E=(max-min+1)/10;for(var _ in b){var A=_.split("_");S=Number(A[0]),T=Number(A[1]);var B=(b[_]-min)/E;B=0>B?0:B;var N=S+d/2,F=T+d/2;t.fillStyle=r.fillStyle||"#fa8b2e",t.beginPath(),t.arc(N,F,5*B,0,2*Math.PI),t.fill(),t.lineWidth=8*B/10,t.strokeStyle=r.strokeStyle||"#fff",t.stroke(),t.save(),t.font=30*B/10+"px serif",t.textAlign="center",t.textBaseline="middle",0!==b[_]&&r.label.show&&(t.fillStyle="#fff",t.fillText(b[_],N,F),t.restore())}this.endDrawMap()},ClusterDrawer.prototype.formatParam=function(){var t=this.getDrawOptions();t=JSON.stringify(t),t=JSON.parse(t);var e=t.size||60;return e+=t.unit||"px",e=/px$/.test(e)?parseInt(e,10)*this.zoomUnit:parseInt(e,10),t.size=e,t};var min,max,_this={};DensityDrawer.prototype.init=function(){function t(t){a.mapEvent.addEvent(t,function(a){var n=null;if("honeycomb"==i.type){var r=a.offsetX,o=a.offsetY,s=Math.round((o-_this.startY)/_this.depthY),l=s*_this.depthY+_this.startY,h=Math.round((r-_this.startX)/_this.depthX),p=h*_this.depthX+_this.startX;s%2&&(p-=_this.depthX/2),n=e.grids[p+"|"+l].len}else for(var d in e.grids){var g=d.split("_");if(a.offsetX-g[0]<=_this.gridStep&&a.offsetY-g[1]<=_this.gridStep){n=e.grids[d];break}}i.events[t](a,n)})}var e=this,a=this.getMapv(),i=this.getDrawOptions();if(i.events)for(var n in i.events)t(n)},util.inherits(DensityDrawer,Drawer),DensityDrawer.prototype.scale=function(t){var e=this;t.change(function(t,a){e.masker={min:t,max:a},e.ctx=e.getCtx(),e.ctx.clearRect(0,0,e.ctx.canvas.width,e.ctx.canvas.height),e.drawMap()}),this.Scale=t},DensityDrawer.prototype.drawMap=function(){this.beginDrawMap();var t=this,e=this.getCtx(),a=this.getLayer().getData(),i=this.getMapv().getMap(),n=i.getZoom(),r=this.zoomUnit=Math.pow(2,18-n),o=formatParam.call(this),s=o.size,l=i.getMapType().getProjection(),h=l.lngLatToPoint(i.getCenter()),p=h.x-i.getSize().width/2*r,d=new BMap.Pixel(p,h.y+i.getSize().height/2*r),g={data:a,nwMc:d,size:s,zoomUnit:r,ctx:e},c={};c="honeycomb"===this.getDrawOptions().type?honeycombGrid(g):recGrids(g,i);var u=this.grids=c.grids;this.dataRange.setMax(c.max),this.dataRange.setMin(c.min);var f=c.max,y=c.min,g={size:s,zoomUnit:r,max:f,min:y,ctx:e,grids:u,fillColors:o.colors,dataRange:this.dataRange,sup:t},c={};"honeycomb"===this.getDrawOptions().type?drawHoneycomb.call(this,g):drawRec.call(this,g),this.Scale&&this.Scale.set({max:f,min:y,colors:this.getDrawOptions().gradient||"default"}),this.endDrawMap()};var r=0,g=0,b=0;util.inherits(HeatmapDrawer,Drawer),HeatmapDrawer.prototype.drawMap=function(){var t=this;t.Scale&&t.Scale.set({min:0,max:t.getMax(),colors:this.getGradient()}),this.beginDrawMap();var e=this.getCtx();this._width=e.canvas.width,this._height=e.canvas.height;var a=this.getLayer().getData();this._data=a,this._width>0&&this._height>0&&this.drawHeatmap(),this.endDrawMap()},HeatmapDrawer.prototype.scale=function(t){var e=this;t.change(function(t,a){e.masker={min:t,max:a},e.drawMap()}),e.Scale=t},util.extend(HeatmapDrawer.prototype,{defaultRadius:10,defaultGradient:{.4:"blue",.6:"cyan",.7:"lime",.8:"yellow","1.0":"red"},getGradient:function(){return this.getDrawOptions().gradient||this.defaultGradient},getMax:function(){var t=this._max;if(void 0!==this.getDrawOptions().max)t=this.getDrawOptions().max;else{var e=this.getLayer().getDataRange();t=e.min+.7*(e.max-e.min)}return t},data:function(t){return this._data=t,this},max:function(t){return this._max=t,this},add:function(t){return this._data.push(t),this},clear:function(){return this._data=[],this},radius:function(t){var e=this._circle=document.createElement("canvas"),a=e.getContext("2d"),i=0;i=void 0!==this.getDrawOptions().shadowBlur?parseFloat(this.getDrawOptions().shadowBlur):0;var n=this._r=t+i;"rect"===this.getDrawOptions().type?e.width=e.height=n:e.width=e.height=2*n;var r;if(void 0!==this.getDrawOptions().shadowBlur)a.shadowBlur=i,a.shadowColor="black",r=1e4;else{r=0;var o=a.createRadialGradient(n-r,n-r,0,n-r,n-r,t);o.addColorStop(0,"rgba(0, 0, 0, 1)"),o.addColorStop(1,"rgba(0, 0, 0, 0)"),a.fillStyle=o}return a.shadowOffsetX=a.shadowOffsetY=r,a.beginPath(),"rect"===this.getDrawOptions().type?a.fillRect(-r,-r,e.width,e.height):a.arc(n-r,n-r,t,0,2*Math.PI,!0),a.closePath(),a.fill(),this},drawHeatmap:function(t){this.radius(this.getRadius());var e=this.getCtx();e.save(),e.clearRect(0,0,this._width,this._height);var a=this.getLayer().getDataType(),i=this.getMax();if("polyline"===a){e.strokeStyle=this.getDrawOptions().strokeStyle||"rgba(0, 0, 0, 0.8)",e.lineWidth=this.getDrawOptions().lineWidth||1,e.beginPath();for(var n=0,r=this._data.length;r>n;n++){l=this._data[n];var o=l.pgeo;e.beginPath(),e.moveTo(o[0][0],o[0][1]);for(var s=1;s<o.length;s++)e.lineTo(o[s][0],o[s][1]);e.globalAlpha=Math.max(l.count/i,void 0===t?.05:t),e.stroke()}}else for(var l,h=this.getDrawOptions().boundary||this._circle.width+50,n=0,r=this._data.length;r>n;n++)l=this._data[n],l.px<-h||l.py<-h||l.px>e.canvas.width+h||l.py>e.canvas.height+h,e.globalAlpha=Math.max(l.count/i,void 0===t?.05:t),e.drawImage(this._circle,l.px-this._r,l.py-this._r);var p=e.getImageData(0,0,this._width,this._height);return this.colorize(p.data,this.dataRange.getGradient()),e.putImageData(p,0,0),e.restore(),this},colorize:function(t,e){var a=0,i=1024;this.masker.min&&(a=this.masker.min/this.getMax()*1024),this.masker.max&&(i=this.masker.max/this.getMax()*1024);for(var n,r=this.getDrawOptions().maxOpacity||.8,o=3,s=t.length;s>o;o+=4)n=4*t[o],t[o]/256>r&&(t[o]=256*r),n&&n>=a&&i>=n?(t[o-3]=e[n],t[o-2]=e[n+1],t[o-1]=e[n+2]):t[o]=0}}),util.inherits(IntensityDrawer,Drawer),IntensityDrawer.prototype.defaultGradient={"0.0":"yellow","1.0":"red"},IntensityDrawer.prototype.drawMap=function(){this.Scale&&this.Scale.set({min:0,max:this.getMax(),colors:this.getGradient()}),this.dataRange.setMax(this.getMax()),this.beginDrawMap();var t=this,e=this.getCtx();e.clearRect(0,0,e.canvas.width,e.canvas.height);var a=this.getLayer().getData(),i=this.getDrawOptions();e.strokeStyle=i.strokeStyle;var n=e.canvas.width,r=e.canvas.height,o=this.getRadius(),s=this.getLayer().getDataType(),l=i.label,h=this.getMap().getZoom();if(l&&l.font&&(e.font=l.font),"polygon"===s||"polyline"===s)for(var p=0,d=a.length;d>p;p++){var g=a[p],c=g.pgeo,u=t.masker.min&&g.count<t.masker.min,f=t.masker.max&&g.count>t.masker.max;if(!u&&!f){e.beginPath(),e.moveTo(c[0][0],c[0][1]),e.fillStyle=this.dataRange.getColorByGradient(a[p].count);for(var y=1;y<c.length;y++)e.lineTo(c[y][0],c[y][1]);if("polygon"==s&&(e.closePath(),e.fill()),"polyline"==s?(e.strokeStyle=this.dataRange.getColorByGradient(a[p].count),e.stroke()):i.strokeStyle&&e.stroke(),l&&l.show&&(!l.minZoom||l.minZoom&&h>=l.minZoom)){l.fillStyle&&(e.fillStyle=l.fillStyle);var m=util.getGeoCenter(c);e.fillText(a[p].count,m[0],m[1])}}}else for(var p=0,d=a.length;d>p;p++){var g=a[p];if(!(g.px<0||g.px>n||g.py<0||g.py>r)){var u=t.masker.min&&g.count<t.masker.min,f=t.masker.max&&g.count>t.masker.max;u||f||(e.beginPath(),e.moveTo(g.px,g.py),e.fillStyle=this.dataRange.getColorByGradient(g.count),e.arc(g.px,g.py,o||1,0,2*Math.PI),e.closePath(),e.fill())}}i.strokeStyle&&e.stroke(),this.endDrawMap()},IntensityDrawer.prototype.getGradient=function(){return this.getDrawOptions().gradient||this.defaultGradient},IntensityDrawer.prototype.scale=function(t){var e=this;t.change(function(t,a){e.masker={min:t,max:a},e.drawMap()}),e.Scale=t},IntensityDrawer.prototype.getMax=function(){var t=this.getLayer().getDataRange(),e=t.max;return this.getDrawOptions().max&&(e=this.getDrawOptions().max),e},util.inherits(LineDrawer,Drawer),LineDrawer.prototype.drawMap=function(t){this.beginDrawMap();var e=this.getCtx(),a=this.getLayer().getData(),i=this.getMapv().getMap(),n=i.getZoom(),r=this.zoomUnit=Math.pow(2,18-n),o=formatParam.call(this),s=(o.size,i.getMapType().getProjection()),l=s.lngLatToPoint(i.getCenter()),h=l.x-i.getSize().width/2*r;new BMap.Pixel(h,l.y+i.getSize().height/2*r);e.globalCompositeOperation="lighter",e.strokeStyle="rgba(100,100,10,0.4)",e.lineWidth=.8;for(var p=0,d=a.length;d>p;p++){e.beginPath();var g=a[p].pgeo;e.moveTo(g[0][0],g[0][1]);for(var c=1;c<g.length;c++)g[c][0]<-100&&g[c][1]<-100||e.lineTo(g[c][0],g[c][1]);e.stroke()}this.endDrawMap()},util.inherits(SimpleDrawer,Drawer),SimpleDrawer.prototype.drawMap=function(t){var e=this.getLayer().getDataType();if("webgl"===this.getLayer().getContext())return void("polyline"===e?this.drawWebglPolyline():this.drawWebglPoint());this.beginDrawMap();var a=this.getLayer().getData(),i=this.getCtx(),n=this.getDrawOptions();i.beginPath();var r=this.getRadius();if("polyline"===e||"polygon"===e){var o=n.label,s=this.getMap().getZoom(),l=Math.pow(2,18-s),h=(10+this.getDrawOptions().lineWidth)/l;if(o){o.font&&(i.font=o.font);var p=o.key||"count"}for(var d=this.getLayer().getAnimationOptions()||{},g=0,c=a.length;c>g;g++){var u=a[g].pgeo,f=0,y=u.length-1;if(t)for(var m=d.scope||10800,v=0;v<u.length&&(parseFloat(u[v][2])<t-m&&(f=v),y=v,!(parseFloat(u[v][2])>t));v++);if(!(f>=y)){i.beginPath(),i.lineWidth=this.getDrawOptions().lineWidth||1,i.moveTo(u[f][0],u[f][1]);for(var v=f+1;y>=v;v++)i.lineTo(u[v][0],u[v][1]);(n.strokeStyle||"polyline"===e)&&(i.stroke(),i.closePath()),i.beginPath(),i.moveTo(u[f][0],u[f][1]);var w=parseInt(l);w=Math.max(w,1),i.lineWidth=1;for(var v=f+1;y>=v;v+=w)if(n.arrow){i.save();var x=[u[v][0]-u[v-1][0],u[v-1][1]-u[v][1]],b=x[1],_=Math.sqrt(x[0]*x[0]+x[1]*x[1],2),C=b/_,D=Math.acos(C);if(x[0]<0&&(D=-D),D){h=Math.max(h,5);var S=[(u[v][0]-u[v-1][0])/2,(u[v][1]-u[v-1][1])/2];i.translate(u[v][0],u[v][1]),i.rotate(D),i.moveTo(h,h),i.lineTo(0,0),i.moveTo(-h,h),i.lineTo(0,0),i.translate(-u[v][0],-u[v][1]),i.moveTo(u[v][0],u[v][1])}i.restore()}if((n.strokeStyle||"polyline"===e)&&i.stroke(),"polygon"===e&&(i.closePath(),i.fill()),o&&o.show&&(!o.minZoom||o.minZoom&&s>=o.minZoom)){i.save(),o.fillStyle&&(i.fillStyle=o.fillStyle);var S=util.getGeoCenter(u);i.fillText(a[g][p],S[0],S[1]),i.restore()}}}}else{var T=n.icon;if(n.strokeStyle||n.globalCompositeOperation)for(var g=0,c=a.length;c>g;g++){var M=a[g];M.px<0||M.px>i.canvas.width||M.py<0||M>i.canvas.height||(i.beginPath(),i.moveTo(M.px,M.py),T&&T.show&&T.url?this.drawIcon(i,M,T):(i.arc(M.px,M.py,r,0,2*Math.PI,!1),i.fill()),n.strokeStyle&&i.stroke())}else{for(var g=0,c=a.length;c>g;g++){var M=a[g];M.px<0||M.px>i.canvas.width||M.py<0||M>i.canvas.height||(i.moveTo(M.px,M.py),T&&T.show&&T.url?this.drawIcon(i,M,T):2>r?i.fillRect(M.px,M.py,2*r,2*r):i.arc(M.px,M.py,r,0,2*Math.PI,!1))}i.fill()}}this.endDrawMap()},SimpleDrawer.prototype.drawIcon=function(t,e,a){var i=new Image,n=a.sx||0,r=a.sy||0,o=a.px||0,s=a.py||0,l=a.swidth||0,h=a.sheight||0,p=a.width||0,d=a.height||0;!function(e,a,n,r,l,h,p){i.onload=function(){var d=util.getPixelRatio(t);t.save(),t.scale(d,d),t.drawImage(i,a,n,r,l,e.px-h/2-o,e.py-p/2-s,h,p),t.restore()}}(e,n,r,l,h,p,d),i.src=a.url},SimpleDrawer.prototype.drawAnimation=function(){var t=this.getLayer(),e=t.getData(),a=t.getDataType(),i=t.getAnimationOptions(),n=t.getAnimation(),r=t.getAnimationCtx();if("polyline"===a)if("time"===n);else for(var o=i.step||1,s=i.size||1,l=0,h=e.length;h>l;l+=o){var p=e[l].index,d=e[l].pgeo,g=util.getPixelRatio(r);r.save(),r.scale(g,g);var c=d[p][0],u=d[p][1],f=r.createRadialGradient(c,u,0,c,u,s);f.addColorStop(0,"rgba(255, 255, 255, 1)"),f.addColorStop(.4,"rgba(255, 255, 255, 0.9)"),f.addColorStop(1,"rgba(255, 255, 255, 0)"),r.fillStyle=i.fillStyle||f,r.beginPath(),r.arc(c,u,s,0,2*Math.PI,!1),r.closePath(),r.fill(),e[l].index++,e[l].index>=e[l].pgeo.length&&(e[l].index=0),r.restore()}},SimpleDrawer.prototype.drawWebglPoint=function(){var t=this.getLayer().getData();if(t){var e,a,i,n,r=this.getCtx();e=r.createShader(r.VERTEX_SHADER),a=r.createShader(r.FRAGMENT_SHADER),i=["attribute vec4 a_Position;","attribute float a_PointSize;","void main() {","gl_Position = a_Position;","gl_PointSize = a_PointSize;","}"].join(""),n=["precision mediump float;","uniform vec4 u_FragColor;","void main() {","gl_FragColor = u_FragColor;","}"].join("");var o=r.createProgram();r.shaderSource(e,i),r.compileShader(e),r.shaderSource(a,n),r.compileShader(a),r.attachShader(o,e),r.attachShader(o,a),r.linkProgram(o),r.useProgram(o);var s=r.getAttribLocation(o,"a_Position"),l=r.getAttribLocation(o,"a_PointSize"),h=r.getUniformLocation(o,"u_FragColor");r.clear(r.COLOR_BUFFER_BIT);for(var p=r.canvas.width/2,d=r.canvas.height/2,g=[],c=0,u=0;u<t.length;u++){var f=t[u],y=(f.px-p)/p,m=(d-f.py)/d;-1>y||y>1||-1>m||m>1||(g.push(y,m),c++)}var v=new Float32Array(g),w=c,x=r.createBuffer();if(!x)return-1;r.bindBuffer(r.ARRAY_BUFFER,x),r.bufferData(r.ARRAY_BUFFER,v,r.STATIC_DRAW),r.vertexAttribPointer(s,2,r.FLOAT,!1,0,0),r.enableVertexAttribArray(s),r.vertexAttrib1f(l,this.getRadius());var b=document.createElement("canvas"),_=b.getContext("2d");b.width=1,b.height=1,_.fillStyle=this.getDrawOptions().fillStyle,_.fillRect(0,0,1,1);var C=_.getImageData(0,0,1,1).data;r.uniform4f(h,C[0]/255,C[1]/255,C[2]/255,C[3]/255),r.drawArrays(r.POINTS,0,w)}},SimpleDrawer.prototype.drawWebglPolyline=function(){var t=this.getLayer().getData();if(t){var e,a,i,n,r=this.getCtx();e=r.createShader(r.VERTEX_SHADER),a=r.createShader(r.FRAGMENT_SHADER),i=["attribute vec4 a_Position;","void main() {","gl_Position = a_Position;","gl_PointSize = 30.0;","}"].join(""),n=["precision mediump float;","uniform vec4 u_FragColor;","void main() {","gl_FragColor = u_FragColor;","}"].join("");var o=r.createProgram();r.shaderSource(e,i),r.compileShader(e),r.shaderSource(a,n),r.compileShader(a),r.attachShader(o,e),r.attachShader(o,a),r.linkProgram(o),r.useProgram(o),r.enable(r.BLEND),r.blendFunc(r.SRC_ALPHA,r.ONE),r.clear(r.COLOR_BUFFER_BIT);var s=r.canvas.width/2,l=r.canvas.height/2,h=r.createBuffer();r.bindBuffer(r.ARRAY_BUFFER,h);var p=r.getAttribLocation(o,"a_Position");r.vertexAttribPointer(p,2,r.FLOAT,!1,0,0),r.enableVertexAttribArray(p);var d=r.getUniformLocation(o,"u_FragColor"),g=document.createElement("canvas"),c=g.getContext("2d");g.width=1,g.height=1,c.fillStyle=this.getDrawOptions().strokeStyle||"red",c.fillRect(0,0,1,1);var u=c.getImageData(0,0,1,1).data;r.uniform4f(d,u[0]/255,u[1]/255,u[2]/255,u[3]/255),r.lineWidth(this.getDrawOptions().lineWidth||1);for(var f=0,y=t.length;y>f;f++){for(var m=t[f].pgeo,v=[],w=0;w<m.length;w++){var x=m[w],b=(x[0]-s)/s,_=(l-x[1])/l;v.push(b,_)}var C=new Float32Array(v);r.bufferData(r.ARRAY_BUFFER,C,r.STATIC_DRAW),r.drawArrays(r.LINE_STRIP,0,m.length)}}},Mapv.Layer=Layer,window.Mapv=Mapv}();